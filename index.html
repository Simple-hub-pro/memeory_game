import React, { useState, useEffect, useRef } from 'react';

const MemoryGame = () => {
  // Emoji to'plamlari
  const emojiSets = {
    classic: ['üéÆ', 'üöÄ', 'üé®', 'üéµ', '‚öΩ', 'üçï', 'üåü', 'ü¶Ñ'],
    animals: ['üê∂', 'üê±', 'üê∞', 'üêª', 'ü¶ä', 'üê∏', 'üê∑', 'üêµ'],
    fruits: ['üçé', 'üçå', 'üçä', 'üçá', 'üçì', 'ü•ù', 'üçë', 'ü•≠'],
    vehicles: ['üöó', 'üöï', 'üöô', 'üöå', 'üöé', 'üèéÔ∏è', 'üöì', 'üöë'],
    nature: ['üå∫', 'üåª', 'üå∑', 'üåπ', 'üå∏', 'üåº', 'üåµ', 'üå≤'],
    sports: ['‚öΩ', 'üèÄ', 'üèà', '‚öæ', 'üéæ', 'üèê', 'üèì', 'üè∏']
  };

  // Qiyinchilik darajalari
  const difficulties = {
    easy: { name: 'Oson', size: 4, pairs: 8 },
    medium: { name: "O'rta", size: 6, pairs: 18 },
    hard: { name: 'Qiyin', size: 8, pairs: 32 }
  };

  const [gameState, setGameState] = useState('menu'); // menu, playing, won
  const [difficulty, setDifficulty] = useState('easy');
  const [emojiSet, setEmojiSet] = useState('classic');
  const [cards, setCards] = useState([]);
  const [flippedCards, setFlippedCards] = useState([]);
  const [matchedPairs, setMatchedPairs] = useState([]);
  const [moves, setMoves] = useState(0);
  const [timeElapsed, setTimeElapsed] = useState(0);
  const [gameStartTime, setGameStartTime] = useState(null);
  const [bestTimes, setBestTimes] = useState({
    easy: null,
    medium: null,
    hard: null
  });
  
  const audioRef = useRef(null);
  const timerRef = useRef(null);

  // Ovozli effektlar (Web Audio API)
  const playSound = (type) => {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
    
    switch(type) {
      case 'flip':
        oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
        break;
      case 'match':
        oscillator.frequency.setValueAtTime(660, audioContext.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(880, audioContext.currentTime + 0.2);
        break;
      case 'win':
        oscillator.frequency.setValueAtTime(523, audioContext.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(1047, audioContext.currentTime + 0.5);
        break;
      default:
        oscillator.frequency.setValueAtTime(220, audioContext.currentTime);
    }
    
    oscillator.start();
    oscillator.stop(audioContext.currentTime + 0.5);
  };

  // Timer
  useEffect(() => {
    if (gameState === 'playing' && gameStartTime) {
      timerRef.current = setInterval(() => {
        setTimeElapsed(Math.floor((Date.now() - gameStartTime) / 1000));
      }, 1000);
    } else {
      clearInterval(timerRef.current);
    }
    
    return () => clearInterval(timerRef.current);
  }, [gameState, gameStartTime]);

  // O'yinni boshlash
  const initializeGame = () => {
    const currentDifficulty = difficulties[difficulty];
    const symbols = emojiSets[emojiSet].slice(0, currentDifficulty.pairs);
    
    const shuffledCards = [...symbols, ...symbols]
      .sort(() => Math.random() - 0.5)
      .map((symbol, index) => ({
        id: index,
        symbol,
        isFlipped: false,
        isMatched: false
      }));
    
    setCards(shuffledCards);
    setFlippedCards([]);
    setMatchedPairs([]);
    setMoves(0);
    setTimeElapsed(0);
    setGameStartTime(Date.now());
    setGameState('playing');
  };

  // Kartani ochish
  const flipCard = (cardId) => {
    if (flippedCards.length === 2 || 
        cards.find(card => card.id === cardId)?.isMatched ||
        flippedCards.includes(cardId)) {
      return;
    }

    playSound('flip');
    const newFlippedCards = [...flippedCards, cardId];
    setFlippedCards(newFlippedCards);

    if (newFlippedCards.length === 2) {
      setMoves(moves + 1);
      const [firstCard, secondCard] = newFlippedCards.map(id => 
        cards.find(card => card.id === id)
      );

      if (firstCard.symbol === secondCard.symbol) {
        // Mos keldi
        playSound('match');
        setTimeout(() => {
          setMatchedPairs([...matchedPairs, firstCard.symbol]);
          setFlippedCards([]);
        }, 500);
      } else {
        // Mos kelmadi
        setTimeout(() => {
          setFlippedCards([]);
        }, 1000);
      }
    }
  };

  // O'yin tugaganini tekshirish
  useEffect(() => {
    const currentDifficulty = difficulties[difficulty];
    if (matchedPairs.length === currentDifficulty.pairs && gameState === 'playing') {
      playSound('win');
      setGameState('won');
      
      // Eng yaxshi vaqtni saqlash
      if (!bestTimes[difficulty] || timeElapsed < bestTimes[difficulty]) {
        setBestTimes(prev => ({
          ...prev,
          [difficulty]: timeElapsed
        }));
      }
    }
  }, [matchedPairs, difficulty, gameState, timeElapsed, bestTimes]);

  const isCardVisible = (card) => {
    return flippedCards.includes(card.id) || matchedPairs.includes(card.symbol);
  };

  const formatTime = (seconds) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  // Menu sahifasi
  if (gameState === 'menu') {
    return (
      <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-purple-600 via-blue-600 to-teal-600 p-4">
        <div className="bg-white rounded-2xl shadow-2xl p-8 text-center max-w-lg w-full">
          <h1 className="text-4xl font-bold text-gray-800 mb-6">
            üß† Memory O'yini
          </h1>
          
          {/* Qiyinchilik darajasi */}
          <div className="mb-6">
            <h3 className="text-lg font-semibold text-gray-700 mb-3">Qiyinchilik darajasi:</h3>
            <div className="grid grid-cols-3 gap-2">
              {Object.entries(difficulties).map(([key, diff]) => (
                <button
                  key={key}
                  onClick={() => setDifficulty(key)}
                  className={`p-3 rounded-lg font-semibold transition-all ${
                    difficulty === key 
                      ? 'bg-purple-500 text-white transform scale-105' 
                      : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                  }`}
                >
                  {diff.name}
                  <div className="text-xs">{diff.size}x{diff.size}</div>
                </button>
              ))}
            </div>
          </div>

          {/* Emoji to'plami */}
          <div className="mb-6">
            <h3 className="text-lg font-semibold text-gray-700 mb-3">Emoji to'plami:</h3>
            <div className="grid grid-cols-2 gap-2">
              {Object.entries(emojiSets).map(([key, emojis]) => (
                <button
                  key={key}
                  onClick={() => setEmojiSet(key)}
                  className={`p-3 rounded-lg font-semibold transition-all ${
                    emojiSet === key 
                      ? 'bg-blue-500 text-white transform scale-105' 
                      : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                  }`}
                >
                  <div className="text-2xl mb-1">{emojis.slice(0, 3).join('')}</div>
                  <div className="text-xs capitalize">{key}</div>
                </button>
              ))}
            </div>
          </div>

          {/* Eng yaxshi vaqtlar */}
          <div className="mb-6">
            <h3 className="text-lg font-semibold text-gray-700 mb-3">üèÜ Eng yaxshi vaqtlar:</h3>
            <div className="text-sm text-gray-600">
              {Object.entries(difficulties).map(([key, diff]) => (
                <div key={key} className="flex justify-between">
                  <span>{diff.name}:</span>
                  <span className="font-mono">
                    {bestTimes[key] ? formatTime(bestTimes[key]) : '--:--'}
                  </span>
                </div>
              ))}
            </div>
          </div>

          <button
            onClick={initializeGame}
            className="bg-gradient-to-r from-purple-500 to-blue-500 text-white px-8 py-4 rounded-lg text-xl font-semibold hover:from-purple-600 hover:to-blue-600 transform hover:scale-105 transition-all duration-200 shadow-lg w-full"
          >
            O'yinni Boshlash üöÄ
          </button>
        </div>
      </div>
    );
  }

  const currentDifficulty = difficulties[difficulty];
  const gridCols = currentDifficulty.size === 4 ? 'grid-cols-4' : 
                   currentDifficulty.size === 6 ? 'grid-cols-6' : 'grid-cols-8';

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-600 via-blue-600 to-teal-600 p-4">
      <div className="max-w-4xl mx-auto">
        {/* Header */}
        <div className="bg-white rounded-xl shadow-lg p-4 mb-6">
          <div className="flex justify-between items-center flex-wrap gap-4">
            <h1 className="text-2xl font-bold text-gray-800">Memory O'yini</h1>
            <div className="flex gap-6">
              <div className="text-center">
                <div className="text-2xl font-bold text-purple-600">{moves}</div>
                <div className="text-sm text-gray-600">Harakat</div>
              </div>
              <div className="text-center">
                <div className="text-2xl font-bold text-blue-600">{matchedPairs.length}/{currentDifficulty.pairs}</div>
                <div className="text-sm text-gray-600">Juftlik</div>
              </div>
              <div className="text-center">
                <div className="text-2xl font-bold text-green-600 font-mono">{formatTime(timeElapsed)}</div>
                <div className="text-sm text-gray-600">Vaqt</div>
              </div>
            </div>
          </div>
        </div>

        {/* Game Board */}
        <div className={`grid ${gridCols} gap-2 mb-6 max-w-2xl mx-auto`}>
          {cards.map((card) => (
            <div
              key={card.id}
              onClick={() => flipCard(card.id)}
              className={`
                aspect-square rounded-xl cursor-pointer transform transition-all duration-300 flex items-center justify-center font-bold shadow-lg
                ${currentDifficulty.size === 8 ? 'text-2xl' : 'text-3xl'}
                ${isCardVisible(card)
                  ? matchedPairs.includes(card.symbol)
                    ? 'bg-gradient-to-br from-green-400 to-green-600 text-white scale-105 animate-pulse'
                    : 'bg-gradient-to-br from-yellow-400 to-orange-500 text-white'
                  : 'bg-gradient-to-br from-gray-300 to-gray-500 hover:from-gray-400 hover:to-gray-600 hover:scale-105'
                }
              `}
            >
              {isCardVisible(card) ? card.symbol : '?'}
            </div>
          ))}
        </div>

        {/* G'alaba modal */}
        {gameState === 'won' && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-2xl shadow-2xl p-8 text-center max-w-sm animate-bounce">
              <div className="text-6xl mb-4">üéâ</div>
              <h2 className="text-3xl font-bold text-gray-800 mb-2">Tabriklaymiz!</h2>
              <div className="text-gray-600 mb-4 space-y-1">
                <p>Vaqt: <span className="font-mono font-bold">{formatTime(timeElapsed)}</span></p>
                <p>Harakatlar: <span className="font-bold">{moves}</span></p>
                <p>Daraja: <span className="font-bold">{currentDifficulty.name}</span></p>
                {bestTimes[difficulty] === timeElapsed && (
                  <p className="text-green-600 font-bold">üèÜ Yangi rekord!</p>
                )}
              </div>
              <div className="flex gap-2">
                <button
                  onClick={initializeGame}
                  className="bg-gradient-to-r from-green-500 to-blue-500 text-white px-4 py-2 rounded-lg font-semibold hover:from-green-600 hover:to-blue-600 transform hover:scale-105 transition-all duration-200 shadow-lg"
                >
                  Qayta O'ynash
                </button>
                <button
                  onClick={() => setGameState('menu')}
                  className="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-4 py-2 rounded-lg font-semibold hover:from-purple-600 hover:to-pink-600 transform hover:scale-105 transition-all duration-200 shadow-lg"
                >
                  Menyu
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Tugmalar */}
        <div className="text-center space-x-4">
          <button
            onClick={initializeGame}
            className="bg-white text-purple-600 px-6 py-2 rounded-lg font-semibold hover:bg-gray-100 transform hover:scale-105 transition-all duration-200 shadow-lg"
          >
            Qayta Boshlash
          </button>
          <button
            onClick={() => setGameState('menu')}
            className="bg-white text-blue-600 px-6 py-2 rounded-lg font-semibold hover:bg-gray-100 transform hover:scale-105 transition-all duration-200 shadow-lg"
          >
            Menyu
          </button>
        </div>
      </div>
    </div>
  );
};

export default MemoryGame;
